# N fert effect on AGN
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
AGN_full_lmer = summary(emmeans(AGN_full_lmer, ~Ntrt_fac * Nfix))
leafNarea_boxplot = boxplot(log(subset(biomass_core_spei, Ntrt_fac == '0' & Nfix == 'no')$AGN),
log(subset(biomass_core_spei, Ntrt_fac == '1' & Nfix == 'no')$AGN),
log(subset(biomass_core_spei, Ntrt_fac == '0' & Nfix == 'yes')$AGN),
log(subset(biomass_core_spei, Ntrt_fac == '1' & Nfix == 'yes')$AGN),
ylim = c(0, 3000), yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', col = c('white', 'white', 'yellow', 'yellow'))
points(AGN_full_lmer[,3], pch = 16, col = c('purple', 'purple', 'red', 'red'), cex = 2)
segments(seq(1, 4, 1), AGN_full_lmer[,3] + AGN_full_lmer[,4] * 1.96, seq(1, 4, 1),
AGN_full_lmer[,3] - AGN_full_lmer[,4] * 1.96, col = c('purple', 'purple', 'red', 'red'),
lwd = 6)
axis(1, at = seq(1, 4, 1), c("-N", '+N', '-N', '+N'), cex.axis = 2)
text(1.5, 2500, 'non-fixers', cex = 2)
text(3.5, 2500, 'N-fixers', cex = 2)
axis(2, seq(0, 3000, 500), cex.axis = 2, las = 1)
mtext(side = 2, 'AGN', cex = 3, line = 5)
# climate effect on ∆N
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = p_pet_cols,  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 50), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 3)
mtext(side = 2, '∆AGN', line = 5, cex = 3)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = p_pet_cols,  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 3)
mtext(side = 2, '∆AGN', line = 5, cex = 3)
anova(lm_deltaN)
summary(lm_deltaN)
names(summary(lm_deltaN))
summary(lm_deltaN)$coefficients
summary(lm_deltaN)$coefficients[1, 1]
deltaN_line = summary(lm_deltaN)$coefficients[1, 1] + summary(lm_deltaN)$coefficients[3, 1] * seq(0, 1, 0.1)
deltaN_line
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
biomass_core_spei_nofix_mean_nN$par_rat_Mean
summary(lm_deltaN)$coefficients[3, 1]
lm_deltaN = lm(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean)
anova(lm_deltaN)
summary(lm_deltaN)
deltaN_line = summary(lm_deltaN)$coefficients[1, 1] + summary(lm_deltaN)$coefficients[2, 1] * seq(0, 1, 0.1)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = p_pet_cols,  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 3)
mtext(side = 2, '∆AGN', line = 5, cex = 3)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 3)
mtext(side = 2, '∆AGN', line = 5, cex = 3)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
summary(lm_deltaN)$coefficients[1, 1]
text(0.1, 290, 'p = 0.15')
text(0.1, 290, 'p = 0.15', cex = 1.8)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 3)
mtext(side = 2, '∆AGN', line = 5, cex = 3)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.1, 290, 'p = 0.15', cex = 1.8)
mtext(side = 2, '∆N per ground area', line = 5, cex = 3)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 3)
mtext(side = 2, '∆N per ground area', line = 5, cex = 3)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.1, 290, 'p = 0.15', cex = 1.8)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 3)
mtext(side = 2, '∆N per ground area (%)', line = 5, cex = 3)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.1, 290, 'p = 0.15', cex = 1.8)
mtext(side = 2, '∆N per ground area (%)', line = 5, cex = 2)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 2)
mtext(side = 2, '∆N per ground area (%)', line = 5, cex = 2)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.1, 290, 'p = 0.15', cex = 1.8)
deltaN
mean(deltaN)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 2)
mtext(side = 2, '∆tissue N per ground area (%)', line = 5, cex = 2)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.1, 290, 'p = 0.15; mean = +80%', cex = 1.8)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 2)
mtext(side = 2, '∆tissue N per ground area (%)', line = 5, cex = 2)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.5, 290, 'p = 0.15; mean = +80%', cex = 1.8)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaN ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 2)
mtext(side = 2, '∆N per ground area (%)', line = 5, cex = 2)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.5, 290, 'p = 0.15; mean = +80%', cex = 1.8)
library(lme4)
library(car)
library(emmeans)
library(dplyr)
library(plyr)
library(RColorBrewer)
library(multcompView)
library(ggplot2)
#########################################
# read in and modify foliar trait dataset (Jen Firn)
#########################################
leaf = read.csv('../Data/NutNet-foliar-traits-7JAN2017.csv')
setwd("/Users/nicksmith/Documents/Git/NutNetPhys/Analysis")
leaf = read.csv('../Data/NutNet-foliar-traits-7JAN2017.csv')
leaf[leaf == 'NULL'] <- NA
leaf[, 8:30] <- sapply(leaf[, 8:30], as.character)
leaf[, 8:30] <- sapply(leaf[, 8:30], as.numeric)
leaf$Ntrt = 0
leaf$Ntrt[leaf$trt == 'N' | leaf$trt == 'NP' | leaf$trt == 'NK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1
leaf$Ptrt = 0
leaf$Ptrt[leaf$trt == 'P' | leaf$trt == 'NP' | leaf$trt == 'PK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1
leaf$Ktrt = 0
leaf$Ktrt[leaf$trt == 'K' | leaf$trt == 'NK' | leaf$trt == 'PK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1
leaf$Ntrt_fac = as.factor(leaf$Ntrt)
leaf$Ptrt_fac = as.factor(leaf$Ptrt)
leaf$Ktrt_fac = as.factor(leaf$Ktrt)
leaf$Narea = leaf$leaf_pct_N * (1/leaf$SLA)
leaf$Nfix = 'no'
leaf$Nfix[leaf$Family == 'Fabaceae'] = 'yes'
# add core data to the dataset
core = read.csv('../Data/comb-by-plot-09-April-2018.csv')
core[core == 'NULL'] <- NA
core[, 26:45] <- sapply(core[, 26:45], as.character)
core[, 26:45] <- sapply(core[, 26:45], as.numeric)
core$par_rat = core$Ground_PAR / core$Ambient_PAR
leaf_core = join(leaf, core, by = c("site_code", "year", "block", "plot", "trt"), type = 'left', match = 'first')
# add SPEI to "leaf_core" data
spei = read.csv('../Data/CRU-annual_2018-07-06.csv')
spei$p_pet = spei$precip / spei$PET
leaf_core_spei = join(leaf_core, spei, by = c("site_code", "year"), type = 'left', match = 'first')
# check
nrow(leaf)
nrow(leaf_core) # some core data matches the leaf data twice...
nrow(leaf_core_spei)
hist(leaf_core_spei $leaf_pct_N)
leafNper_lmer = lmer(leaf_pct_N ~ Ntrt_fac * Nfix + p_pet + (1|site_code) + (1|Family) + (1|Taxon) + (1|site_code:Family) + (1|site_code:Taxon), data = leaf_core_spei)
plot(resid(leafNper_lmer) ~ fitted(leafNper_lmer))
Anova(leafNper_lmer)
emmeans(leafNper_lmer, ~Ntrt_fac)
cld(emmeans(leafNper_lmer, ~Ntrt_fac * Nfix)) # percent N is higher in N addition by ~12%
leafNarea_lmer = lmer(log(Narea) ~ Ntrt_fac * Nfix + p_pet + (1|site_code) + (1|Family) + (1|Taxon) + (1|site_code:Family) + (1|site_code:Taxon), data = leaf_core_spei)
plot(resid(leafNarea_lmer) ~ fitted(leafNarea_lmer))
Anova(leafNarea_lmer)
cld(emmeans(leafNarea_lmer, ~Ntrt_fac))
Anova(leafNarea_lmer)
leaf_core_spei_nofix = subset(leaf_core_spei, Nfix == 'no')
leaf_core_spei_nofix_group = group_by(leaf_core_spei_nofix, site_code, year, Ntrt_fac)
leaf_core_spei_nofix_mean = summarise_all(leaf_core_spei_nofix_group, .funs = funs(Mean = mean(., na.rm = T), SD = sd(., na.rm = T)))
leaf_core_spei_nofix_mean_yN = subset(leaf_core_spei_nofix_mean, Ntrt_fac == '1')
leaf_core_spei_nofix_mean_nN = subset(leaf_core_spei_nofix_mean, Ntrt_fac == '0')
nrow(leaf_core_spei_nofix_mean_yN)
nrow(leaf_core_spei_nofix_mean_nN)
deltaNper = ((leaf_core_spei_nofix_mean_yN$leaf_pct_N_Mean - leaf_core_spei_nofix_mean_nN$leaf_pct_N_Mean) / leaf_core_spei_nofix_mean_nN$leaf_pct_N_Mean) * 100
deltaNarea = ((leaf_core_spei_nofix_mean_yN$Narea_Mean - leaf_core_spei_nofix_mean_nN$Narea_Mean) / leaf_core_spei_nofix_mean_nN$Narea_Mean) * 100
summary(lm(deltaNper ~ leaf_core_spei_nofix_mean_nN$p_pet_Mean)) # nothing
summary(lm(deltaNarea ~ leaf_core_spei_nofix_mean_nN$p_pet_Mean)) # nothing
summary(lm(deltaNper ~ leaf_core_spei_nofix_mean_nN$p_pet_Mean)) # nothing
summary(lm(deltaNarea ~ leaf_core_spei_nofix_mean_nN$p_pet_Mean)) # nothing
plot(deltaNper ~ leaf_core_spei_nofix_mean_nN$p_pet_Mean)
plot(deltaNarea ~ leaf_core_spei_nofix_mean_nN$p_pet_Mean)
plot(deltaNper ~ leaf_core_spei_nofix_mean_nN$par_rat_Mean)
plot(deltaNarea ~ leaf_core_spei_nofix_mean_nN$par_rat_Mean)
summary(lm(deltaNper ~ leaf_core_spei_nofix_mean_nN$precip.mean_Mean)) # nothing
summary(lm(deltaNarea ~ leaf_core_spei_nofix_mean_nN$precip.mean_Mean)) # nothing
plot(deltaNper ~ leaf_core_spei_nofix_mean_nN$precip.mean_Mean)
plot(deltaNarea ~ leaf_core_spei_nofix_mean_nN$precip.mean_Mean)
lm_deltaNarea = lm(deltaNarea ~ leaf_core_spei_nofix_mean_nN$p_pet_Mean * leaf_core_spei_nofix_mean_nN$par_rat_Mean)
anova(lm_deltaNarea)
summary(lm_deltaNarea)
anova(lm_deltaNarea)
summary(lm_deltaNarea)
lm_deltaNarea = lm(deltaNarea ~ leaf_core_spei_nofix_mean_nN$par_rat_Mean)
anova(lm_deltaNarea)
deltaNarea_line = summary(lm_deltaNarea)$coefficients[1, 1] + summary(lm_deltaNarea)$coefficients[2, 1] * seq(0, 1, 0.1)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaNarea ~ biomass_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaNarea ~ leaf_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 2)
mtext(side = 2, '∆N per leaf area (%)', line = 5, cex = 2)
lines(deltaN_line ~ seq(0, 1, 0.1), lwd = 4)
lines(deltaNarea_line ~ seq(0, 1, 0.1), lwd = 4)
anova(lm_deltaNarea)
mean(lm_deltaNarea)
mean(lm_deltaNarea, na.rm = T)
mean(deltaNarea, na.rm = T)
deltaNarea_line = summary(lm_deltaNarea)$coefficients[1, 1] + summary(lm_deltaNarea)$coefficients[2, 1] * seq(0, 1, 0.1)
par(mfrow = c(1, 1), oma = c(4, 4, 1, 1))
palette = colorRampPalette(brewer.pal(9,'Blues'))
#p_pet_cols <- palette(9)[as.numeric(cut(biomass_core_spei_nofix_mean_nN$p_pet_Mean,breaks = 9))]
plot(deltaNarea ~ leaf_core_spei_nofix_mean_nN$par_rat_Mean, pch =21, cex = 3, bg = 'blue',  yaxt = 'n', xaxt = 'n', ylab = '', xlab = '', xlim = c(0, 1), ylim = c(-100, 300))
axis(1, seq(0, 1, 0.2), cex.axis = 2)
axis(2, seq(-100, 300, 100), cex.axis = 2, las = 1)
mtext(side = 1, 'Light interception', line = 4, cex = 2)
mtext(side = 2, '∆N per leaf area (%)', line = 5, cex = 2)
lines(deltaNarea_line ~ seq(0, 1, 0.1), lwd = 4)
text(0.5, 290, 'p = 0.35; mean = +12%', cex = 1.8)
## load libraries
library(R.utils)
library(lme4)
library(car)
# install.packages("devtools")
library(devtools)
devtools::install_github("hohenstein/remef")
library(remef)
library(emmeans)
library(tidyverse)
library(caret)
library(relaimpo)
## load optimal vcmax script (Smith et al., Ecology Letters)
source('optimal_vcmax_R/calc_optimal_vcmax_nutnet.R')
sourceDirectory('optimal_vcmax_R/functions')
traits = read.csv('../Data/leaf_plus.csv')
head(traits)
## fiter by overlapping sites
source('filer_sites.R')
traits = filter(traits, site_code %in% overlap)
## make sure factors are correctly defined
traits$Ntrt_fac = as.factor(traits$Ntrt_fac)
traits$Ptrt_fac = as.factor(traits$Ptrt_fac)
traits$Ktrt_fac = as.factor(traits$Ktrt_fac)
traits$photosynthetic_pathway[traits$photosynthetic_pathway == 'NULL'
& traits$Family == 'Cyperaceae' & traits$Taxon == 'FIMBRISTYLIS DICHOTOMA'] <- 'C4'
traits$photosynthetic_pathway[traits$photosynthetic_pathway == 'NULL'] <- 'C3'
## calculate lma (in g m-2) and narea
hist(traits$leaf_area_mm2)
traits$la_m2 = traits$leaf_area_mm2 * (1/1000000)
traits$lma = traits$leaf_dry_mass_g / traits$la_m2
traits$narea = (traits$leaf_pct_N / 100) * (traits$lma)
hist(traits$lma) # some extremely high values
hist(traits$narea) # some extremely high values
hist(traits$SLA)
hist(traits$la_m2)
hist(traits$leaf_dry_mass_g) # some very hig values
## some light calculations
traits$lai = -log(traits$Ground_PAR / traits$Ambient_PAR) / 0.86 # from: http://manuals.decagon.com/Manuals/10242_Accupar%20LP80_Web.pdf page 41
hist(traits$lai)
### calculate par per leaf area to assume par absorbed is reduced in dense canopies
traits$par_per_leaf_area = traits$par * ((1 - exp(-0.5 * traits$lai)) / traits$lai) # from Dong et al. (2007) eqn 2
hist(traits$par_per_leaf_area)
hist(traits$Ambient_PAR)
hist(traits$par)
hist(((1 - exp(-0.5 * traits$lai)) / traits$lai))
## remove C4 and values without d13c
traits_sub = subset(traits, lma > 0 & leaf_dry_mass_g < 100 & photosynthetic_pathway == 'C3' & leaf_C13_delta_PDB != 'NA'
& leaf_C13_delta_PDB < -20 & trt != 'Fence' & trt != 'NPK+Fence')
traits_sub$delta = (-8 - traits_sub$leaf_C13_delta_PDB) / (1 + traits_sub$leaf_C13_delta_PDB * 0.001)
traits_sub$chi = (traits_sub$delta - 4.4) / (27 - 4.4)
hist(traits_sub$lma) # some extremely high values
hist(traits_sub$narea) # some extremely high values
hist(traits_sub$la_m2)
hist(traits_sub$leaf_dry_mass_g) #
hist(traits_sub$chi) # looks good
## calculate optimal trait values
traits_photo = calc_optimal_vcmax(tg_c = traits_sub$tmp, paro = traits_sub$par_per_leaf_area, cao = 400,
vpdo = traits_sub$vpd, z = traits_sub$z,chi = traits_sub$chi)
traits_sub$vcmax25_mod = traits_photo$vcmax25
traits_sub$vcmax25_mod[traits_sub$vcmax25_mod < 0] <- NA
plot(traits_sub$vcmax25_mod ~ traits_sub$tmp)
traits_sub$n_rubisco_mod = traits_sub$vcmax25_mod * (1/3500000) * (1/8) * 550000 * .0114 * 14
traits_sub$n_structure_mod = (10^-2.67) * (traits_sub$lma ^ 0.99)
hist(traits_sub$n_rubisco_mod)
hist(traits_sub$n_structure_mod)
## fit some models for N following Dong et al. (2017) but also include fertilization
### all individuals
n_pred_all_lm = lm(log(narea) ~ chi + log(par_per_leaf_area) + tmp + log(lma) + Nfix + trt, data = traits_sub)
summary(n_pred_all_lm) # not much of a chi response
anova(n_pred_all_lm)
plot(resid(n_pred_all_lm) ~ fitted(n_pred_all_lm))
# plot(log(narea) ~ chi + log(par_per_leaf_area) + tmp + log(lma) + Nfix + trt, data = traits_sub)
emmeans(n_pred_all_lm, ~Nfix)
cld(emmeans(n_pred_all_lm, ~trt)) # N is highest
calc.relimp(n_pred_all_lm, rela = T) # lma = 60%, tmp = 26%, par = 1% chi = 12%, trt = 0.2%, Nfix = 2%
n_pred_model_lm = lm(log(narea) ~ log(n_rubisco_mod) + log(n_structure_mod) + trt, data = subset(traits_sub, Nfix == 'no'))
Anova(n_pred_model_lm)
summary(n_pred_model_lm)
plot(resid(n_pred_model_lm) ~ fitted(n_pred_model_lm))
# plot(log(narea) ~ log(n_rubisco_mod) + log(n_structure_mod) + trt, data = subset(traits_sub, Nfix == 'no'))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_rubisco_mod)', at = list(Nfix = 'no')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_rubisco_mod)', at = list(Nfix = 'yes')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_structure_mod)', at = list(Nfix = 'no')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_structure_mod)', at = list(Nfix = 'yes')))
calc.relimp(n_pred_model_lm, rela = T) # 81% structure, 19% rubisco, treatment = 0.03%
summary(n_pred_all_lm) # not much of a chi response
summary(n_pred_model_lm)
calc.relimp(n_pred_all_lm, rela = T) # lma = 60%, tmp = 26%, par = 1% chi = 12%, trt = 0.2%, Nfix = 2%
# plot(log(narea) ~ log(n_rubisco_mod) + log(n_structure_mod) + trt, data = subset(traits_sub, Nfix == 'no'))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_rubisco_mod)', at = list(Nfix = 'no')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_rubisco_mod)', at = list(Nfix = 'yes')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_structure_mod)', at = list(Nfix = 'no')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_structure_mod)', at = list(Nfix = 'yes')))
calc.relimp(n_pred_model_lm, rela = T) # 81% structure, 19% rubisco, treatment = 0.03%
### examining the different components
# n_pred_model_lm = lm(log(narea) ~ (log(n_rubisco_mod) + log(n_structure_mod)) * Nfix, data = traits_sub)
n_pred_model_lm = lm(log(narea) ~ log(n_rubisco_mod) + log(n_structure_mod) + Nfix + trt, data = traits_sub)
Anova(n_pred_model_lm)
summary(n_pred_model_lm)
plot(resid(n_pred_model_lm) ~ fitted(n_pred_model_lm))
# plot(log(narea) ~ log(n_rubisco_mod) + log(n_structure_mod) + trt, data = subset(traits_sub, Nfix == 'no'))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_rubisco_mod)', at = list(Nfix = 'no')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_rubisco_mod)', at = list(Nfix = 'yes')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_structure_mod)', at = list(Nfix = 'no')))
# test(emtrends(n_pred_model_lm, ~1, var = 'log(n_structure_mod)', at = list(Nfix = 'yes')))
calc.relimp(n_pred_model_lm, rela = T) # 81% structure, 19% rubisco, treatment = 0.03%
## load libraries
library(R.utils)
library(lme4)
library(car)
# install.packages("devtools")
library(devtools)
devtools::install_github("hohenstein/remef")
library(remef)
library(emmeans)
library(tidyverse)
library(caret)
library(relaimpo)
## load optimal vcmax script (Smith et al., Ecology Letters)
source('optimal_vcmax_R/calc_optimal_vcmax_nutnet.R')
sourceDirectory('optimal_vcmax_R/functions')
traits = read.csv('../Data/leaf_plus.csv')
head(traits)
## fiter by overlapping sites
source('filer_sites.R')
## fiter by overlapping sites
source('filter_sites.R')
## fiter by overlapping sites
source('filter_sites.R')
traits$Ntrt_fac = as.factor(traits$Ntrt_fac)
traits$Ptrt_fac = as.factor(traits$Ptrt_fac)
traits$Ktrt_fac = as.factor(traits$Ktrt_fac)
## add in photosynthetic pathway information
levels(traits$Family) # check Amaranthaceae, Asteraceae, Boraginaceae, Caryophyllaceae, Cyperaceae, Euphorbiaceae,
# Polygonaceae, Poaceae, Scrophulariaceae
traits$photosynthetic_pathway[traits$photosynthetic_pathway == 'NULL'
& traits$Family == 'Cyperaceae' & traits$Taxon == 'FIMBRISTYLIS DICHOTOMA'] <- 'C4'
traits$photosynthetic_pathway[traits$photosynthetic_pathway == 'NULL'] <- 'C3'
## calculate lma (in g m-2) and narea
hist(traits$leaf_area_mm2)
traits$la_m2 = traits$leaf_area_mm2 * (1/1000000)
traits$lma = traits$leaf_dry_mass_g / traits$la_m2
traits$narea = (traits$leaf_pct_N / 100) * (traits$lma)
hist(traits$lma) # some extremely high values
hist(traits$narea) # some extremely high values
hist(traits$SLA)
hist(traits$la_m2)
hist(traits$leaf_dry_mass_g) # some very hig values
hist(subset(traits, leaf_dry_mass_g < 100)$leaf_dry_mass_g)
## some light calculations
traits$lai = -log(traits$Ground_PAR / traits$Ambient_PAR) / 0.86 # from: http://manuals.decagon.com/Manuals/10242_Accupar%20LP80_Web.pdf page 41
hist(traits$lai)
### calculate par per leaf area to assume par absorbed is reduced in dense canopies
traits$par_per_leaf_area = traits$par * ((1 - exp(-0.5 * traits$lai)) / traits$lai) # from Dong et al. (2007) eqn 2
hist(traits$par_per_leaf_area)
hist(traits$Ambient_PAR)
hist(traits$par)
hist(((1 - exp(-0.5 * traits$lai)) / traits$lai))
## remove C4 and values without d13c
traits_sub = subset(traits, lma > 0 & leaf_dry_mass_g < 100 & photosynthetic_pathway == 'C3' & leaf_C13_delta_PDB != 'NA'
& leaf_C13_delta_PDB < -20 & trt != 'Fence' & trt != 'NPK+Fence')
traits_sub$delta = (-8 - traits_sub$leaf_C13_delta_PDB) / (1 + traits_sub$leaf_C13_delta_PDB * 0.001)
traits_sub$chi = (traits_sub$delta - 4.4) / (27 - 4.4)
hist(traits_sub$lma) # some extremely high values
hist(traits_sub$narea) # some extremely high values
hist(traits_sub$la_m2)
hist(traits_sub$leaf_dry_mass_g) #
hist(traits_sub$chi) # looks good
## calculate optimal trait values
traits_photo = calc_optimal_vcmax(tg_c = traits_sub$tmp, paro = traits_sub$par_per_leaf_area, cao = 400,
vpdo = traits_sub$vpd, z = traits_sub$z,chi = traits_sub$chi)
traits_sub$vcmax25_mod = traits_photo$vcmax25
traits_sub$vcmax25_mod[traits_sub$vcmax25_mod < 0] <- NA
plot(traits_sub$vcmax25_mod ~ traits_sub$tmp)
## calculate N from rubisco and structure
### from Ning Dong and Harrison et al. (2009): Nrubisco (g per m2) = ((vcmax25 * Mr * nr) / (kcat * Nr)) * Mn
### vcmax25 = vcmax at 25C (umol m-2 s-1)
### Nr = number of catalytic sites per mole of Rubisco = 8 mol Rubisco site per mol Rubisco
### kcat = catalytic turnover at 25C = 3.5 CO2 per mol Rubisco site per second
### Mr = molecular mass of Rubisco = 0.55 g Rubisco per umol Rubisco (550000 g Rubisco per mol Rubisco)
### nr = N concentration of Rubisco = 11400 mol N per g Rubisco
### Mn = molecular mass of N = 14 gN per mol N
# https://onlinelibrary.wiley.com/doi/full/10.1111/j.1365-3040.2008.01918.x
### lma conversion from Dong et al. (2017) Biogeosciences
traits_sub$n_rubisco_mod = traits_sub$vcmax25_mod * (1/3500000) * (1/8) * 550000 * .0114 * 14
traits_sub$n_structure_mod = (10^-2.67) * (traits_sub$lma ^ 0.99)
hist(traits_sub$n_rubisco_mod)
hist(traits_sub$n_structure_mod)
## fit some models for N following Dong et al. (2017) but also include fertilization
### all individuals
n_pred_all_lm = lm(log(narea) ~ chi + log(par_per_leaf_area) + tmp + log(lma) + Nfix + trt, data = traits_sub)
summary(n_pred_all_lm) # not much of a chi response
anova(n_pred_all_lm)
plot(resid(n_pred_all_lm) ~ fitted(n_pred_all_lm))
# plot(log(narea) ~ chi + log(par_per_leaf_area) + tmp + log(lma) + Nfix + trt, data = traits_sub)
emmeans(n_pred_all_lm, ~Nfix)
cld(emmeans(n_pred_all_lm, ~trt)) # N is highest
calc.relimp(n_pred_all_lm, rela = T) # lma = 60%, tmp = 26%, par = 1% chi = 12%, trt = 0.2%, Nfix = 2%
setwd("/Users/nicksmith/Documents/Git/NutNetPhys/Analysis")
#########################################
# packages necessary
#########################################
library(lme4)
library(car)
library(emmeans)
library(dplyr)
library(plyr)
library(RColorBrewer)
library(multcompView)
library(ggplot2)
#########################################
# read in and modify foliar trait dataset (Jen Firn)
#########################################
leaf = read.csv('../Data/NutNet-foliar-traits-7JAN2017.csv')
leaf[leaf == 'NULL'] <- NA
leaf[, 8:30] <- sapply(leaf[, 8:30], as.character)
leaf[, 8:30] <- sapply(leaf[, 8:30], as.numeric)
leaf$Ntrt = 0
leaf$Ntrt[leaf$trt == 'N' | leaf$trt == 'NP' | leaf$trt == 'NK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1
leaf$Ptrt = 0
leaf$Ptrt[leaf$trt == 'P' | leaf$trt == 'NP' | leaf$trt == 'PK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1
leaf$Ktrt = 0
leaf$Ktrt[leaf$trt == 'K' | leaf$trt == 'NK' | leaf$trt == 'PK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1
leaf$Ntrt_fac = as.factor(leaf$Ntrt)
leaf$Ptrt_fac = as.factor(leaf$Ptrt)
leaf$Ktrt_fac = as.factor(leaf$Ktrt)
leaf$Narea = leaf$leaf_pct_N * (1/leaf$SLA)
leaf$Nfix = 'no'
leaf$Nfix[leaf$Family == 'Fabaceae'] = 'yes'
# add core data to the dataset
core = read.csv('../Data/comb-by-plot-09-April-2018.csv')
core[core == 'NULL'] <- NA
core[, 26:45] <- sapply(core[, 26:45], as.character)
core[, 26:45] <- sapply(core[, 26:45], as.numeric)
core$par_rat = core$Ground_PAR / core$Ambient_PAR
leaf_core = join(leaf, core, by = c("site_code", "year", "block", "plot", "trt"), type = 'left', match = 'first')
# add SPEI to "leaf_core" data
spei = read.csv('../Data/CRU-annual_2018-07-06.csv')
spei$p_pet = spei$precip / spei$PET
leaf_core_spei = join(leaf_core, spei, by = c("site_code", "year"), type = 'left', match = 'first')
# check
nrow(leaf)
nrow(leaf_core) # some core data matches the leaf data twice...
nrow(leaf_core_spei)
hist(leaf_core_spei $leaf_pct_N)
leafNper_lmer = lmer(leaf_pct_N ~ Ntrt_fac * Nfix + p_pet + (1|site_code) + (1|Family) + (1|Taxon) + (1|site_code:Family) + (1|site_code:Taxon), data = leaf_core_spei)
plot(resid(leafNper_lmer) ~ fitted(leafNper_lmer))
Anova(leafNper_lmer)
emmeans(leafNper_lmer, ~Ntrt_fac)
cld(emmeans(leafNper_lmer, ~Ntrt_fac * Nfix)) # percent N is higher in N addition by ~12%
cld(emmeans(leafNper_lmer, ~Ntrt_fac * Nfix)) # percent N is higher in N addition by ~12%
cld(emmeans(leafNarea_lmer, ~Ntrt_fac * Nfix)) # ~2% increase in non-N fixers
leafNarea_lmer = lmer(log(Narea) ~ Ntrt_fac * Nfix + p_pet + (1|site_code) + (1|Family) + (1|Taxon) + (1|site_code:Family) + (1|site_code:Taxon), data = leaf_core_spei)
plot(resid(leafNarea_lmer) ~ fitted(leafNarea_lmer))
Anova(leafNarea_lmer)
cld(emmeans(leafNarea_lmer, ~Ntrt_fac))
cld(emmeans(leafNarea_lmer, ~Ntrt_fac * Nfix)) # ~2% increase in non-N fixers
summary(n_pred_all_lm) # not much of a chi response
